---
import LayoutSidebar from '../../app/LayoutSidebar.astro';
import { fetchPedidos, getCurrentUser } from '../../lib/api.ts';

// Verificar permisos
const user = await getCurrentUser();
const userRoles = user?.roles || [];

// Si no hay usuario, permitir acceso (para desarrollo - se puede restringir después)
// Si hay usuario, verificar permisos
if (user) {
	const canAccess = userRoles.includes('ADMIN') || userRoles.includes('MOZO') || userRoles.includes('COCINERO');
	if (!canAccess) {
		return Astro.redirect('/acceso-denegado');
	}
}

const pedidos = await fetchPedidos();
---

<LayoutSidebar>
	<div class="px-4 pt-6">
		<div class="mb-4 flex justify-between items-center">
			<div>
				<h1 class="text-2xl font-bold text-gray-900 dark:text-white">Gestión de Pedidos</h1>
				<p class="text-gray-600 dark:text-gray-400">Administra pedidos y órdenes</p>
			</div>
			{(!user || userRoles.includes('ADMIN') || userRoles.includes('MOZO')) && (
				<a
					href="/crud/pedidos/nuevo"
					class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700"
				>
					Nuevo Pedido
				</a>
			)}
		</div>

		<div class="relative overflow-x-auto shadow-md sm:rounded-lg">
			<table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
				<thead
					class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
				>
					<tr>
						<th scope="col" class="px-6 py-3">ID</th>
						<th scope="col" class="px-6 py-3">Mesa</th>
						<th scope="col" class="px-6 py-3">Cliente</th>
						<th scope="col" class="px-6 py-3">Fecha/Hora</th>
						<th scope="col" class="px-6 py-3">Estado</th>
						<th scope="col" class="px-6 py-3">Acciones</th>
					</tr>
				</thead>
				<tbody>
					{pedidos.map((pedido) => (
						<tr
							class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600"
						>
							<td class="px-6 py-4">{pedido.idPedido}</td>
							<td class="px-6 py-4">{pedido.mesa?.numero || '-'}</td>
							<td class="px-6 py-4">
								{pedido.cliente
									? `${pedido.cliente.nombres} ${pedido.cliente.apellidos}`
									: 'Sin cliente'}
							</td>
							<td class="px-6 py-4">
								{new Date(pedido.fechaHora).toLocaleString('es-PE')}
							</td>
							<td class="px-6 py-4">
								<span
									class={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
										pedido.estado === 'pendiente'
											? 'bg-yellow-100 text-yellow-800'
											: pedido.estado === 'en preparación'
												? 'bg-blue-100 text-blue-800'
												: pedido.estado === 'servido'
													? 'bg-green-100 text-green-800'
													: 'bg-gray-100 text-gray-800'
									}`}
								>
									{pedido.estado}
								</span>
							</td>
							<td class="px-6 py-4">
								<a
									href={`/crud/pedidos/editar/${pedido.idPedido}`}
									class="font-medium text-blue-600 dark:text-blue-500 hover:underline mr-3"
									>Editar</a
								>
								{userRoles.includes('COCINERO') && pedido.estado === 'pendiente' && (
									<button
										type="button"
										data-pedido-id={pedido.idPedido}
										class="confirmar-pedido-btn font-medium text-green-600 dark:text-green-500 hover:underline ml-3"
									>
										Confirmar
									</button>
								)}
							</td>
						</tr>
					))}
					{pedidos.length === 0 && (
						<tr>
							<td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
								No hay pedidos registrados
							</td>
						</tr>
					)}
				</tbody>
			</table>
		</div>
	</div>
</LayoutSidebar>

<script>
	// Agregar event listeners a los botones de confirmar
	document.addEventListener('DOMContentLoaded', () => {
		const confirmarButtons = document.querySelectorAll('.confirmar-pedido-btn');
		confirmarButtons.forEach(button => {
			button.addEventListener('click', async () => {
				const idPedido = button.getAttribute('data-pedido-id');
				if (!confirm('¿Confirmar que este pedido está en preparación?')) {
					return;
				}

				try {
					// Obtener el pedido actual
					const response = await fetch(`http://localhost:8081/api/pedidos/${idPedido}`, {
						credentials: 'include'
					});
					
					if (!response.ok) {
						alert('Error al obtener el pedido');
						return;
					}

					const pedido = await response.json();
					
					// Actualizar el estado a "en preparación"
					const updatedPedido = {
						...pedido,
						estado: 'en preparación'
					};

					const updateResponse = await fetch(`http://localhost:8081/api/pedidos/${idPedido}`, {
						method: 'PUT',
						headers: {
							'Content-Type': 'application/json',
						},
						credentials: 'include',
						body: JSON.stringify(updatedPedido),
					});

					if (updateResponse.ok) {
						window.location.reload();
					} else {
						alert('Error al confirmar el pedido');
					}
				} catch (error) {
					console.error('Error:', error);
					alert('Error al confirmar el pedido');
				}
			});
		});
	});
</script>

